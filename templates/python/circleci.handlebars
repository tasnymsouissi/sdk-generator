version: 2.1

orbs:
  aws-cli: circleci/aws-cli@2.0.0

workflows:
  main:
    jobs:
      - test:
          context:
            - bm-private-ecr
          filters:
            tags:
              only: /.*/
      - deploy:
          context:
            - bm-private-ecr
          requires:
            - test
          filters:
            tags:
              only: /.*/
            branches:
              ignore: /.*/

commands:
  install-poetry:
    description: Install Poetry
    steps:
      - run: pip install poetry

  check-tags-mismatch:
    description: Check if package and circle tags are matching
    steps:
      - run:
          name: "Check if package and circle tags are matching"
          command: ./scripts/check.sh

  publish-package:
    description: Publish package
    steps:
      - run:
          name: "Publish package"
          command: ./scripts/publish.sh

jobs:
  test:
    docker:
      - image: 154005363564.dkr.ecr.us-east-1.amazonaws.com/docker.io/cimg/python:3.10
    resource_class: small
    steps:
      - checkout
      - run: pip install tox
      - run: tox

  deploy:
    docker:
      - image: 154005363564.dkr.ecr.us-east-1.amazonaws.com/docker.io/cimg/python:3.10
    resource_class: small
    steps:
      - checkout
      - aws-cli/setup
      - install-poetry
      - check-tags-mismatch
      - publish-package
